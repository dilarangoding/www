---
import Layout from "./Layout.astro";
import { getCollection } from "astro:content";

interface Props {
  title: string;
  description: string;
  date: Date;
  image?: string;
  readingTime?: string;
  slug: string;
  tags?: string[];
  showMeta?: boolean;
}

const { title, description, date, image, readingTime = "1 minute read", slug, tags = [], showMeta = true } = Astro.props as Props;

const allPosts = await getCollection("posts");
const otherPosts = allPosts
  .filter((post) => !post.data.draft && post.slug !== slug)
  .filter((post) => {
    if (!tags || tags.length === 0) return false;
    const postTags = (post.data.tags ?? []) as string[];
    return postTags.some((t) => tags.includes(t));
  })
  .sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf())
  .slice(0, 8);
---

<Layout title={title} description={description} image={image}>
  <article class="space-y-8">
    <header class="space-y-3">
      <h1 class="text-2xl font-bold">{title}</h1>
      {showMeta && (
        <div class="text-sm text-gray-600">
          {date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })} {readingTime ? `â€¢ ${readingTime}` : ""}
        </div>
      )}
    </header>

  <div class="post-content max-w-none">
      <slot />
    </div>

  {otherPosts && otherPosts.length > 0 && (
      <section class="mt-16 pt-8 border-t border-gray-200">
        <h2 class="text-lg font-medium mb-6">You might also enjoy</h2>
        <div class="grid grid-cols-1 gap-3">
          {otherPosts.map((post) => (
            <article class="flex justify-between items-start gap-4">
              <div class="flex-1 min-w-0">
                <a
                  href={`/posts/${post.slug}`}
                  class="text-gray-900"
                >
                  {post.data.title}
                </a>
              </div>
              <time class="text-gray-600 whitespace-nowrap">
                {post.data.date.getFullYear()}
              </time>
            </article>
          ))}
        </div>
      </section>
    )}

  </article>
</Layout>
