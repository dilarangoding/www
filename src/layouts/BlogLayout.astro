---
import Layout from "./Layout.astro";
import { getCollection } from "astro:content";

const {
    title,
    description,
    pubDate,
    lastUpdate,
    image,
    slug,
    tags = [],
    readingTime,
    showMeta = true,
} = Astro.props;

const allPosts = await getCollection("posts");
const relatedPosts = allPosts
    .filter((post: any) => !post.data.draft && post.slug !== slug)
    .filter((post: any) => {
        if (!tags || tags.length === 0) return false;
        const postTags = post.data.tags || [];
        return postTags.some((t: any) => tags.includes(t));
    })
    .sort(
        (a: any, b: any) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
    )
    .slice(0, 5);

function formatDate(date: any) {
    return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
}
---

<Layout title={title} description={description} image={image}>
    <article class="space-y-8">
        <header class="space-y-3">
            <h1 class="text-2xl font-bold">{title}</h1>
            {
                showMeta && (
                    <div class="text-xs text-gray-700">
                        {formatDate(pubDate)}
                        {readingTime && <span> â€¢ {readingTime}</span>}
                        {lastUpdate && (
                            <span> | Updated {formatDate(lastUpdate)}</span>
                        )}
                    </div>
                )
            }
        </header>

        <div class="post-content max-w-none">
            <slot />
        </div>

        {
            relatedPosts.length > 0 && (
                <section class="mt-16 pt-8 border-t border-gray-200">
                    <h2 class="text-lg font-medium mb-6">
                        You might also enjoy
                    </h2>
                    <div class="space-y-3">
                        {relatedPosts.map((post: any) => (
                            <article class="flex justify-between items-start gap-4">
                                <a
                                    href={`/${post.slug}`}
                                    class="text-gray-900 flex-1"
                                >
                                    {post.data.title}
                                </a>
                                <time class="text-gray-600 text-sm whitespace-nowrap">
                                    {post.data.pubDate.getFullYear()}
                                </time>
                            </article>
                        ))}
                    </div>
                </section>
            )
        }
    </article>
</Layout>
